import VideoPlayer from"../components/player/index.js";import API from"../core/api.js";import Auth from"../core/auth.js";class PlayerPage{constructor(){this.player=null,this.dramaId=null,this.episodeId=null,this.dramaData=null,this.episodeData=null,this.init()}async init(){this.parseUrlParams(),await this.loadDramaData(),this.initPlayer(),this.loadEpisodeList(),this.setupEventListeners(),this.checkVIPAccess(),this.recordWatchHistory()}parseUrlParams(){const e=new URLSearchParams(window.location.search);this.dramaId=e.get("drama")||"demo_001",this.episodeId=e.get("episode")||1}async loadDramaData(){try{document.querySelector(".page-loading").classList.add("show");const e=await API.get(`/dramas/${this.dramaId}`);this.dramaData=e.data,this.episodeData=this.dramaData.episodes.find(e=>e.id===this.episodeId)||this.dramaData.episodes[0],document.querySelector(".episode-title").textContent=`${this.dramaData.title} - Episode ${this.episodeData.episodeNumber}`,document.querySelector(".episode-description").textContent=this.episodeData.description}catch(e){console.error("Failed to load drama data:",e),this.showError("剧集加载失败")}finally{document.querySelector(".page-loading").classList.remove("show")}}initPlayer(){const e=this.buildSources(),t=this.buildSubtitles();this.player=new VideoPlayer("player-container",{sources:e,subtitles:t,poster:this.episodeData.thumbnail,autoplay:!0,enableDanmaku:!0,enableDownload:!0,enablePictureInPicture:!0,defaultQuality:"auto",defaultPlaybackRate:1,theme:"dark"}),this.setupPlayerEvents()}buildSources(){const e=[];return this.episodeData.videos?this.episodeData.videos.forEach(t=>{e.push({url:t.url,quality:t.quality,type:t.type||"video/mp4"})}):e.push({url:this.episodeData.videoUrl,quality:"720p",type:"video/mp4"}),e}buildSubtitles(){const e=[];return this.episodeData.subtitles&&this.episodeData.subtitles.forEach(t=>{e.push({url:t.url,lang:t.language,label:t.label,default:t.default||!1})}),e}setupPlayerEvents(){this.player.on("prevEpisode",()=>{this.switchEpisode(this.episodeId-1)}),this.player.on("nextEpisode",()=>{this.switchEpisode(this.episodeId+1)}),this.player.on("showSubtitleMenu",()=>{this.toggleSubtitleMenu()}),this.player.on("showQualityMenu",()=>{this.toggleQualityMenu()}),this.player.on("showSpeedMenu",()=>{this.toggleSpeedMenu()}),this.player.on("ended",()=>{this.episodeId<this.dramaData.episodes.length&&this.showNextEpisodePrompt(),this.markAsWatched()}),this.player.on("error",e=>{console.error("Player error:",e),this.showError("播放出错，请重试")})}loadEpisodeList(){const e=document.getElementById("episode-list");e&&(e.innerHTML="",this.dramaData.episodes.forEach(t=>{const s=document.createElement("div");s.className="episode-item",t.id===this.episodeId&&s.classList.add("active"),s.innerHTML=`\n                <div class="episode-number">${t.episodeNumber}</div>\n                <div class="episode-info">\n                    <div class="episode-title">${t.title}</div>\n                    <div class="episode-duration">${this.formatDuration(t.duration)}</div>\n                </div>\n                ${t.watched?'<div class="watched-badge">已观看</div>':""}\n            `,s.addEventListener("click",()=>{this.switchEpisode(t.id)}),e.appendChild(s)}))}async switchEpisode(e){if(e===this.episodeId)return;if(this.dramaData.episodes.find(t=>t.id===e).isVip&&!Auth.isVIP())return void this.showVIPPrompt();const t=new URL(window.location);t.searchParams.set("episode",e),window.history.pushState({},"",t),window.location.reload()}toggleSubtitleMenu(){const e=document.querySelector(".player-subtitle-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-quality-menu")?.classList.remove("show"),document.querySelector(".player-speed-menu")?.classList.remove("show"),this.buildSubtitleMenu(e),e.classList.add("show")))}buildSubtitleMenu(e){e.innerHTML="";const t=document.createElement("div");t.className="menu-item",t.textContent="关闭字幕",t.addEventListener("click",()=>{this.player.setSubtitle(null),e.classList.remove("show")}),e.appendChild(t),this.player.options.subtitles.forEach(t=>{const s=document.createElement("div");s.className="menu-item",t.default&&s.classList.add("active"),s.textContent=t.label,s.addEventListener("click",()=>{this.player.setSubtitle(t.lang),e.classList.remove("show")}),e.appendChild(s)})}toggleQualityMenu(){const e=document.querySelector(".player-quality-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-subtitle-menu")?.classList.remove("show"),document.querySelector(".player-speed-menu")?.classList.remove("show"),this.buildQualityMenu(e),e.classList.add("show")))}buildQualityMenu(e){e.innerHTML="",["auto","1080p","720p","480p","360p"].forEach(t=>{const s=document.createElement("div");s.className="menu-item",t===this.player.state.currentQuality&&s.classList.add("active"),s.textContent="auto"===t?"自动":t,s.addEventListener("click",()=>{this.player.setQuality(t),e.classList.remove("show")}),e.appendChild(s)})}toggleSpeedMenu(){const e=document.querySelector(".player-speed-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-quality-menu")?.classList.remove("show"),document.querySelector(".player-subtitle-menu")?.classList.remove("show"),this.buildSpeedMenu(e),e.classList.add("show")))}buildSpeedMenu(e){e.innerHTML="",[.5,.75,1,1.25,1.5,2].forEach(t=>{const s=document.createElement("div");s.className="menu-item",t===this.player.state.playbackRate&&s.classList.add("active"),s.textContent=`${t}x`,s.addEventListener("click",()=>{this.player.setPlaybackRate(t),e.classList.remove("show")}),e.appendChild(s)})}async checkVIPAccess(){this.episodeData.isVip&&!Auth.isVIP()&&this.showVIPOverlay()}showVIPOverlay(){const e=document.createElement("div");e.className="vip-overlay",e.innerHTML='\n            <div class="vip-content">\n                <i class="fas fa-crown"></i>\n                <h3>VIP专属内容</h3>\n                <p>开通VIP会员即可观看本剧集</p>\n                <button class="btn-primary" onclick="window.location.href=\'/payment.html\'">\n                    开通VIP\n                </button>\n            </div>\n        ',document.querySelector(".player-container").appendChild(e)}showVIPPrompt(){confirm("该剧集为VIP专属，是否开通VIP会员？")&&(window.location.href="/payment.html")}showNextEpisodePrompt(){const e=this.dramaData.episodes[this.episodeId];if(!e)return;const t=document.createElement("div");t.className="next-episode-prompt",t.innerHTML=`\n            <div class="prompt-content">\n                <p>下一集: ${e.title}</p>\n                <div class="prompt-actions">\n                    <button class="btn-secondary" onclick="this.closest('.next-episode-prompt').remove()">\n                        取消\n                    </button>\n                    <button class="btn-primary" onclick="window.location.href='?drama=${this.dramaId}&episode=${e.id}'">\n                        播放下一集\n                    </button>\n                </div>\n            </div>\n        `,document.querySelector(".player-container").appendChild(t),setTimeout(()=>{t.remove()},5e3)}async recordWatchHistory(){let e=0;this.player.on("timeupdate",()=>{const t=this.player.state.currentTime;t-e>=30&&(e=t,this.saveWatchProgress(t))})}async saveWatchProgress(e){if(Auth.isLoggedIn())try{await API.post("/watch-history",{dramaId:this.dramaId,episodeId:this.episodeId,progress:e,total:this.player.state.duration})}catch(e){console.error("Failed to save watch progress:",e)}}async markAsWatched(){if(Auth.isLoggedIn())try{await API.post("/watch-history/complete",{dramaId:this.dramaId,episodeId:this.episodeId})}catch(e){console.error("Failed to mark as watched:",e)}}formatDuration(e){if(!e)return"00:00";const t=Math.floor(e/3600),s=Math.floor(e%3600/60),a=Math.floor(e%60);return t>0?`${t}:${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}showError(e){const t=document.createElement("div");t.className="error-toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}setupEventListeners(){document.getElementById("like-btn")?.addEventListener("click",()=>{this.handleLike()}),document.getElementById("favorite-btn")?.addEventListener("click",()=>{this.handleFavorite()}),document.getElementById("share-btn")?.addEventListener("click",()=>{this.handleShare()}),document.getElementById("download-btn")?.addEventListener("click",()=>{this.handleDownload()}),document.addEventListener("fullscreenchange",()=>{this.player.state.isFullscreen=!!document.fullscreenElement})}async handleLike(){if(Auth.isLoggedIn())try{await API.post(`/episodes/${this.episodeId}/like`);const e=document.getElementById("like-btn");e.classList.toggle("active");const t=e.querySelector("span");if(t){let s=parseInt(t.textContent);e.classList.contains("active")?s++:s--,t.textContent=s}}catch(e){console.error("Failed to like:",e)}else window.location.href="/login.html"}async handleFavorite(){if(Auth.isLoggedIn())try{await API.post(`/dramas/${this.dramaId}/favorite`);const e=document.getElementById("favorite-btn");e.classList.toggle("active");const t=e.classList.contains("active")?"已添加到收藏":"已取消收藏";this.showToast(t)}catch(e){console.error("Failed to favorite:",e)}else window.location.href="/login.html"}handleShare(){navigator.share?navigator.share({title:this.episodeData.title,text:`我正在看 ${this.dramaData.title} - ${this.episodeData.title}`,url:window.location.href}).catch(console.error):navigator.clipboard.writeText(window.location.href).then(()=>this.showToast("链接已复制")).catch(console.error)}async handleDownload(){if(Auth.isLoggedIn())if(!this.episodeData.isVip||Auth.isVIP())try{const e=await API.get(`/episodes/${this.episodeId}/download`);if(e.data.downloadUrl){const t=document.createElement("a");t.href=e.data.downloadUrl,t.download=`${this.dramaData.title}_${this.episodeData.title}.mp4`,document.body.appendChild(t),t.click(),document.body.removeChild(t),this.showToast("下载已开始")}}catch(e){console.error("Download failed:",e),this.showError("下载失败")}else this.showVIPPrompt();else window.location.href="/login.html"}showToast(e){const t=document.createElement("div");t.className="toast-message",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.remove()},2e3)}}document.addEventListener("DOMContentLoaded",()=>{new PlayerPage});