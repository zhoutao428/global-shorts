const ffmpeg=require("fluent-ffmpeg"),path=require("path"),fs=require("fs"),OSS=require("ali-oss");class VideoService{constructor(){this.ossClient=new OSS({region:process.env.OSS_REGION,accessKeyId:process.env.OSS_ACCESS_KEY_ID,accessKeySecret:process.env.OSS_ACCESS_KEY_SECRET,bucket:process.env.OSS_BUCKET})}async transcodeVideo(e,s){const t=[{name:"360p",size:"640x360",bitrate:"500k"},{name:"480p",size:"854x480",bitrate:"1000k"},{name:"720p",size:"1280x720",bitrate:"2000k"},{name:"1080p",size:"1920x1080",bitrate:"4000k"}],r=[];for(const n of t){const t=path.join(s,`${n.name}.mp4`);await new Promise((s,r)=>{ffmpeg(e).size(n.size).videoBitrate(n.bitrate).audioBitrate("128k").on("end",s).on("error",r).save(t)}),r.push({quality:n.name,path:t})}return r}async createHLSStream(e,s){const t=path.join(s,"hls");return fs.existsSync(t)||fs.mkdirSync(t,{recursive:!0}),new Promise((s,r)=>{ffmpeg(e).outputOptions(["-codec: h264","-hls_time 10","-hls_list_size 0","-hls_segment_filename",`${t}/segment_%03d.ts`,"-f hls"]).output(`${t}/playlist.m3u8`).on("end",()=>{s({playlist:`${t}/playlist.m3u8`,segments:fs.readdirSync(t).filter(e=>e.endsWith(".ts"))})}).on("error",r).run()})}async uploadToOSS(e,s){try{return(await this.ossClient.put(s,e)).url}catch(e){throw console.error("Upload to OSS failed:",e),e}}async generateSubtitles(e,s){}async addWatermark(e,s,t){return new Promise((r,n)=>{ffmpeg(e).input(t).complexFilter([{filter:"overlay",options:{x:10,y:10}}]).on("end",r).on("error",n).save(s)})}}