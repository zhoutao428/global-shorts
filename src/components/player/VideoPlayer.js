import PlayerControls from"./PlayerControls.js";import QualitySelector from"./QualitySelector.js";import SubtitleManager from"./SubtitleManager.js";import PlaybackRate from"./PlaybackRate.js";import AudioMode from"./AudioMode.js";import DownloadManager from"./DownloadManager.js";import KeyboardShortcuts from"./KeyboardShortcuts.js";import PictureInPicture from"./PictureInPicture.js";import ProgressPreview from"./ProgressPreview.js";import Danmaku from"./Danmaku.js";class VideoPlayer{constructor(e,t={}){if(this.container="string"==typeof e?document.getElementById(e):e,!this.container)throw new Error("Video player container not found");this.options={autoplay:!1,controls:!0,muted:!1,loop:!1,poster:"",sources:[],subtitles:[],playbackRates:[.5,.75,1,1.25,1.5,2],defaultPlaybackRate:1,defaultQuality:"auto",defaultSubtitle:null,enableDanmaku:!1,enableDownload:!0,enablePictureInPicture:!0,enableKeyboard:!0,enableProgressPreview:!0,theme:"dark",...t},this.state={isPlaying:!1,currentTime:0,duration:0,volume:1,muted:this.options.muted,playbackRate:this.options.defaultPlaybackRate,currentQuality:this.options.defaultQuality,currentSubtitle:this.options.defaultSubtitle,buffered:0,isFullscreen:!1,isPiP:!1,isAudioMode:!1,isLoading:!0,error:null},this.components={},this.events={},this.init()}init(){this.createDOM(),this.createVideoElement(),this.loadSources(),this.initComponents(),this.setupEventListeners(),this.applyInitialSettings()}createDOM(){this.container.innerHTML="",this.container.classList.add("global-shorts-player"),this.container.classList.add(`theme-${this.options.theme}`),this.container.innerHTML='\n            <div class="player-container">\n                <div class="player-video-wrapper">\n                    <video class="player-video" playsinline webkit-playsinline x5-playsinline></video>\n                    \n                    \x3c!-- 弹幕容器 --\x3e\n                    <div class="player-danmaku"></div>\n                    \n                    \x3c!-- 加载动画 --\x3e\n                    <div class="player-loading">\n                        <div class="loading-spinner"></div>\n                    </div>\n                    \n                    \x3c!-- 错误提示 --\x3e\n                    <div class="player-error">\n                        <i class="fas fa-exclamation-circle"></i>\n                        <p></p>\n                    </div>\n                    \n                    \x3c!-- 大播放按钮 --\x3e\n                    <div class="player-big-play-btn">\n                        <i class="fas fa-play"></i>\n                    </div>\n                    \n                    \x3c!-- 控制栏容器 --\x3e\n                    <div class="player-controls"></div>\n                    \n                    \x3c!-- 进度预览容器 --\x3e\n                    <div class="player-preview"></div>\n                </div>\n                \n                \x3c!-- 清晰度菜单 --\x3e\n                <div class="player-quality-menu"></div>\n                \n                \x3c!-- 字幕菜单 --\x3e\n                <div class="player-subtitle-menu"></div>\n                \n                \x3c!-- 播放速度菜单 --\x3e\n                <div class="player-speed-menu"></div>\n            </div>\n        ',this.dom={wrapper:this.container.querySelector(".player-video-wrapper"),videoWrapper:this.container.querySelector(".player-video-wrapper"),video:this.container.querySelector(".player-video"),danmaku:this.container.querySelector(".player-danmaku"),loading:this.container.querySelector(".player-loading"),error:this.container.querySelector(".player-error"),errorMsg:this.container.querySelector(".player-error p"),bigPlayBtn:this.container.querySelector(".player-big-play-btn"),controls:this.container.querySelector(".player-controls"),preview:this.container.querySelector(".player-preview"),qualityMenu:this.container.querySelector(".player-quality-menu"),subtitleMenu:this.container.querySelector(".player-subtitle-menu"),speedMenu:this.container.querySelector(".player-speed-menu")}}createVideoElement(){this.video=this.dom.video,this.options.poster&&(this.video.poster=this.options.poster),this.video.muted=this.options.muted,this.video.loop=this.options.loop,this.video.preload="auto",this.video.addEventListener("loadstart",()=>this.handleEvent("loadstart")),this.video.addEventListener("loadedmetadata",()=>this.handleEvent("loadedmetadata")),this.video.addEventListener("loadeddata",()=>this.handleEvent("loadeddata")),this.video.addEventListener("canplay",()=>this.handleEvent("canplay")),this.video.addEventListener("canplaythrough",()=>this.handleEvent("canplaythrough")),this.video.addEventListener("play",()=>this.handleEvent("play")),this.video.addEventListener("playing",()=>this.handleEvent("playing")),this.video.addEventListener("pause",()=>this.handleEvent("pause")),this.video.addEventListener("ended",()=>this.handleEvent("ended")),this.video.addEventListener("waiting",()=>this.handleEvent("waiting")),this.video.addEventListener("stalled",()=>this.handleEvent("stalled")),this.video.addEventListener("seeking",()=>this.handleEvent("seeking")),this.video.addEventListener("seeked",()=>this.handleEvent("seeked")),this.video.addEventListener("timeupdate",()=>this.handleEvent("timeupdate")),this.video.addEventListener("volumechange",()=>this.handleEvent("volumechange")),this.video.addEventListener("ratechange",()=>this.handleEvent("ratechange")),this.video.addEventListener("durationchange",()=>this.handleEvent("durationchange")),this.video.addEventListener("progress",()=>this.handleEvent("progress")),this.video.addEventListener("error",e=>this.handleError(e))}initComponents(){this.components.controls=new PlayerControls(this),this.options.sources.length>0&&(this.components.qualitySelector=new QualitySelector(this)),this.options.subtitles.length>0&&(this.components.subtitleManager=new SubtitleManager(this)),this.components.playbackRate=new PlaybackRate(this),this.components.audioMode=new AudioMode(this),this.options.enableDownload&&(this.components.downloadManager=new DownloadManager(this)),this.options.enableKeyboard&&(this.components.keyboardShortcuts=new KeyboardShortcuts(this)),this.options.enablePictureInPicture&&document.pictureInPictureEnabled&&(this.components.pictureInPicture=new PictureInPicture(this)),this.options.enableProgressPreview&&(this.components.progressPreview=new ProgressPreview(this)),this.options.enableDanmaku&&(this.components.danmaku=new Danmaku(this,this.dom.danmaku))}setupEventListeners(){let e;this.dom.bigPlayBtn.addEventListener("click",()=>this.togglePlay()),this.dom.videoWrapper.addEventListener("click",e=>{e.target.closest(".player-controls")||e.target.closest(".player-quality-menu")||this.togglePlay()}),this.dom.wrapper.addEventListener("mousemove",()=>{this.showControls(),clearTimeout(e),e=setTimeout(()=>{this.state.isPlaying&&!this.state.isAudioMode&&this.hideControls()},3e3)}),this.dom.wrapper.addEventListener("mouseleave",()=>{this.state.isPlaying&&!this.state.isAudioMode&&this.hideControls()})}applyInitialSettings(){this.setPlaybackRate(this.options.defaultPlaybackRate),this.options.defaultSubtitle&&this.setSubtitle(this.options.defaultSubtitle)}loadSources(){if(0!==this.options.sources.length){for(;this.video.firstChild;)this.video.removeChild(this.video.firstChild);this.options.sources.forEach(e=>{const t=document.createElement("source");t.src=e.url,t.type=e.type||"video/mp4",e.quality&&t.setAttribute("data-quality",e.quality),this.video.appendChild(t)}),this.video.load()}}handleEvent(e){switch(e){case"loadedmetadata":this.state.duration=this.video.duration,this.state.isLoading=!1;break;case"timeupdate":this.state.currentTime=this.video.currentTime;break;case"progress":this.video.buffered.length>0&&(this.state.buffered=this.video.buffered.end(this.video.buffered.length-1));break;case"waiting":this.showLoading();break;case"canplay":case"playing":this.hideLoading();break;case"play":this.state.isPlaying=!0,this.dom.bigPlayBtn.classList.add("hidden"),this.container.classList.add("playing");break;case"pause":this.state.isPlaying=!1,this.dom.bigPlayBtn.classList.remove("hidden"),this.container.classList.remove("playing");break;case"volumechange":this.state.volume=this.video.volume,this.state.muted=this.video.muted;break;case"ratechange":this.state.playbackRate=this.video.playbackRate}this.trigger(e,this.state)}handleError(e){const t=this.video.error;this.state.error=t,this.state.isLoading=!1,this.dom.error.classList.add("show");let i="视频加载失败";if(t)switch(t.code){case 1:i="视频加载被中止";break;case 2:i="网络错误导致视频下载失败";break;case 3:i="视频解码失败";break;case 4:i="视频格式不支持"}this.dom.errorMsg.textContent=i,this.trigger("error",{error:t,message:i})}showLoading(){this.dom.loading.classList.add("show")}hideLoading(){this.dom.loading.classList.remove("show")}showControls(){this.dom.controls.classList.add("show"),this.dom.wrapper.style.cursor="default"}hideControls(){this.dom.controls.classList.remove("show"),this.dom.wrapper.style.cursor="none"}play(){const e=this.video.play();void 0!==e&&e.catch(e=>{console.error("Play failed:",e),this.handleError({target:{error:e}})})}pause(){this.video.pause()}togglePlay(){this.video.paused?this.play():this.pause()}seek(e){this.video.currentTime=Math.max(0,Math.min(e,this.state.duration))}setVolume(e){this.video.volume=Math.max(0,Math.min(1,e))}toggleMute(){this.video.muted=!this.video.muted}setPlaybackRate(e){this.video.playbackRate=e}toggleFullscreen(){document.fullscreenElement?(document.exitFullscreen(),this.state.isFullscreen=!1):(this.dom.wrapper.requestFullscreen(),this.state.isFullscreen=!0)}async togglePictureInPicture(){try{document.pictureInPictureElement?(await document.exitPictureInPicture(),this.state.isPiP=!1):(await this.video.requestPictureInPicture(),this.state.isPiP=!0)}catch(e){console.error("Picture-in-Picture failed:",e)}}setQuality(e){const t=this.options.sources.find(t=>t.quality===e);t&&(this.state.currentQuality=e,this.video.src=t.url,this.video.load(),this.state.isPlaying&&this.video.play(),this.trigger("qualitychange",e))}setSubtitle(e){this.components.subtitleManager&&this.components.subtitleManager.setSubtitle(e)}enableAudioMode(){this.components.audioMode&&this.components.audioMode.enable()}disableAudioMode(){this.components.audioMode&&this.components.audioMode.disable()}download(){this.components.downloadManager&&this.components.downloadManager.download()}sendDanmaku(e,t={}){this.components.danmaku&&this.components.danmaku.send(e,t)}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(e=>e!==t))}trigger(e,t){this.events[e]&&this.events[e].forEach(e=>e(t))}destroy(){this.pause(),Object.values(this.components).forEach(e=>{e&&"function"==typeof e.destroy&&e.destroy()}),this.events={},this.container.innerHTML="",this.container.classList.remove("global-shorts-player",`theme-${this.options.theme}`)}}export default VideoPlayer;