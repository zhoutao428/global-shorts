class VideoDownload{constructor(e){this.player=e,this.downloadQueue=[],this.isDownloading=!1}async downloadEpisode(e,o="720p"){if(!await this.checkStorage())return void alert("存储空间不足");const t={id:e,url:await this.getDownloadUrl(e,o),quality:o,progress:0,status:"pending"};return this.downloadQueue.push(t),this.isDownloading||this.processDownloadQueue(),t}async processDownloadQueue(){if(0===this.downloadQueue.length)return void(this.isDownloading=!1);this.isDownloading=!0;const e=this.downloadQueue[0];try{const o=await fetch(e.url),t=o.body.getReader(),s=+o.headers.get("Content-Length");let n=0;const a=[];for(;;){const{done:o,value:r}=await t.read();if(o)break;a.push(r),n+=r.length,e.progress=n/s*100,e.status="downloading",this.updateDownloadProgress(e)}const r=new Blob(a);await this.saveToIndexedDB(e.id,r),e.status="completed",this.downloadQueue.shift(),this.processDownloadQueue()}catch(o){console.error("Download failed:",o),e.status="failed",this.downloadQueue.shift(),this.processDownloadQueue()}}async saveToIndexedDB(e,o){return new Promise((t,s)=>{const n=indexedDB.open("VideoDB",1);n.onerror=s,n.onsuccess=n=>{const a=n.target.result.transaction(["videos"],"readwrite");a.objectStore("videos").put({id:e,blob:o}),a.oncomplete=t,a.onerror=s},n.onupgradeneeded=e=>{e.target.result.createObjectStore("videos",{keyPath:"id"})}})}async getOfflineVideo(e){return new Promise((o,t)=>{const s=indexedDB.open("VideoDB",1);s.onsuccess=s=>{const n=s.target.result.transaction(["videos"],"readonly").objectStore("videos").get(e);n.onsuccess=()=>{if(n.result){const e=URL.createObjectURL(n.result.blob);o(e)}else o(null)},n.onerror=t},s.onerror=t})}async checkStorage(){if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate();return e.quota-e.usage>524288e3}return!0}async getDownloadUrl(e,o){const t=await fetch(`/api/episodes/${e}/download?quality=${o}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});return(await t.json()).downloadUrl}updateDownloadProgress(e){const o=new CustomEvent("downloadProgress",{detail:e});document.dispatchEvent(o)}}export default VideoDownload;