export default class HomePage{constructor(e){this.params=e,this.currentCategory="all",this.searchQuery="",this.page=1,this.isLoading=!1,this.hasMore=!0,this.init()}init(){console.log("Home page initialized",this.params),this.initCategoryTabs(),this.initSearch(),this.initInfiniteScroll(),this.loadDramas(),this.bindEvents()}initCategoryTabs(){const e=document.querySelectorAll(".category-item");e.forEach(a=>{a.addEventListener("click",()=>{const t=a.dataset.category;e.forEach(e=>e.classList.remove("active")),a.classList.add("active"),this.currentCategory=t,this.page=1,this.hasMore=!0,document.getElementById("dramaGrid").innerHTML="",this.loadDramas()})})}initSearch(){const e=document.getElementById("searchInput"),a=document.getElementById("searchBtn");if(!e||!a)return;const t=()=>{const a=e.value.trim();a!==this.searchQuery&&(this.searchQuery=a,this.page=1,this.hasMore=!0,document.getElementById("dramaGrid").innerHTML="",this.loadDramas())};a.addEventListener("click",t),e.addEventListener("keypress",e=>{"Enter"===e.key&&t()})}initInfiniteScroll(){const e=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&!this.isLoading&&this.hasMore&&(this.page++,this.loadDramas())})},{root:null,rootMargin:"0px",threshold:.1}),a=document.getElementById("loadMoreTrigger");a&&e.observe(a)}async loadDramas(){if(!this.isLoading&&this.hasMore){this.isLoading=!0,this.showLoading();try{const e=new URLSearchParams({page:this.page,limit:20,category:"all"!==this.currentCategory?this.currentCategory:"",search:this.searchQuery}),a=await fetch(`/data/dramas.json?${e}`),t=await a.json(),s=20*(this.page-1),n=s+20,i=t.slice(s,n);this.renderDramas(i),this.hasMore=n<t.length}catch(e){console.error("Failed to load dramas:",e),this.showError("加载失败，请重试")}finally{this.isLoading=!1,this.hideLoading()}}}renderDramas(e){const a=document.getElementById("dramaGrid");e.forEach(e=>{const t=this.createDramaCard(e);a.appendChild(t)}),this.updateLoadMoreTrigger()}createDramaCard(e){const a=document.createElement("div");a.className="drama-card",a.dataset.id=e.id;const t=e.watchedEpisodes?e.watchedEpisodes/e.totalEpisodes*100:0;return a.innerHTML=`\n            <div class="drama-thumbnail">\n                <div class="drama-thumbnail" style="background: linear-gradient(135deg, #FF385C, #6B46C1); display: flex; align-items: center; justify-content: center;">\n    <i class="fas fa-film" style="font-size: 48px; color: white; opacity: 0.8;"></i>\n</div>\n                <div class="drama-badges">\n                    ${e.isHot?'<div class="badge hot-badge">HOT</div>':""}\n                    ${e.isNew?'<div class="badge new-badge">NEW</div>':""}\n                    ${e.isVip?'<div class="badge vip-only">VIP</div>':""}\n                </div>\n                <div class="play-overlay">\n                    <div class="play-circle">\n                        <i class="fas fa-play"></i>\n                    </div>\n                </div>\n            </div>\n            <div class="drama-info">\n                <h3 class="drama-title">${e.title}</h3>\n                <div class="drama-meta">\n                    <div class="drama-episodes">\n                        <i class="fas fa-list-ol"></i>\n                        <span>${e.totalEpisodes}集</span>\n                    </div>\n                    <div class="drama-stats">\n                        <i class="fas fa-eye"></i>\n                        <span>${this.formatViews(e.viewCount)}</span>\n                    </div>\n                </div>\n                ${e.watchedEpisodes?`\n                <div class="progress-container">\n                    <div class="progress" style="width: ${t}%"></div>\n                </div>\n                <div class="progress-text">\n                    <span>已观看 ${e.watchedEpisodes}/${e.totalEpisodes}</span>\n                    <span>${Math.round(t)}%</span>\n                </div>\n                `:""}\n            </div>\n        `,a.addEventListener("click",()=>{window.router.navigate(`/player/${e.id}`)}),a}formatViews(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}updateLoadMoreTrigger(){let e=document.getElementById("loadMoreTrigger");e||(e=document.createElement("div"),e.id="loadMoreTrigger",e.className="load-more-trigger",document.getElementById("dramaGrid").after(e)),this.hasMore?e.innerHTML="":e.innerHTML='<p class="end-message">没有更多了</p>'}showLoading(){const e=document.getElementById("dramaLoading");e&&e.classList.add("show")}hideLoading(){const e=document.getElementById("dramaLoading");e&&e.classList.remove("show")}showError(e){const a=new CustomEvent("showToast",{detail:{message:e,type:"error"}});document.dispatchEvent(a)}bindEvents(){document.getElementById("userAvatar")?.addEventListener("click",()=>{window.auth.isLoggedIn()?window.router.navigate("/profile"):window.router.navigate("/login")}),document.getElementById("coinDisplay")?.addEventListener("click",()=>{window.router.navigate("/payment")}),document.getElementById("dailyCheckinBtn")?.addEventListener("click",()=>{window.auth.isLoggedIn()?this.showCheckinModal():window.router.navigate("/login",{redirect:"home"})}),document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",a=>{a.preventDefault();const t=e.dataset.page;t&&"home"!==t&&window.router.navigate(`/${t}`)})})}showCheckinModal(){import("/src/components/common/modal.js").then(e=>{new e.default({title:"每日签到",content:this.renderCheckinContent(),onConfirm:()=>this.handleCheckin()}).show()})}renderCheckinContent(){return'\n            <div class="checkin-calendar">\n                <div class="checkin-grid">\n                    <div class="checkin-day claimed">1 <span>+10</span></div>\n                    <div class="checkin-day claimed">2 <span>+15</span></div>\n                    <div class="checkin-day claimed">3 <span>+20</span></div>\n                    <div class="checkin-day claimed">4 <span>+25</span></div>\n                    <div class="checkin-day today">5 <span>+30</span></div>\n                    <div class="checkin-day">6 <span>+40</span></div>\n                    <div class="checkin-day">7 <span>+50</span></div>\n                </div>\n                <p class="checkin-info">连续签到可获得额外奖励</p>\n            </div>\n        '}async handleCheckin(){try{const e=await fetch("/api/user/checkin",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=await e.json();if(a.success){const e=document.querySelector(".coin-display span");e&&(e.textContent=a.newBalance);const t=new CustomEvent("showToast",{detail:{message:`签到成功！获得${a.reward}金币`,type:"success"}});document.dispatchEvent(t)}}catch(e){console.error("Checkin failed:",e)}}destroy(){console.log("Home page destroyed")}}