import VideoPlayer from"../../components/player/VideoPlayer.js";export default class PlayerPage{constructor(e){this.params=e,this.dramaId=e.id||this.getQueryParam("drama"),this.episodeId=parseInt(this.getQueryParam("episode"))||1,this.dramaData=null,this.episodeData=null,this.player=null,this.isLoading=!1,this.init()}async init(){console.log("Player page initialized",{dramaId:this.dramaId,episodeId:this.episodeId}),this.showLoading(),await this.loadDramaData(),this.updatePageInfo(),this.initPlayer(),this.loadEpisodeList(),this.bindEvents(),this.hideLoading(),this.initWatchHistory()}getQueryParam(e){return new URLSearchParams(window.location.search).get(e)}async loadDramaData(){try{this.dramaData={id:this.dramaId,title:"总裁的秘密婚姻",coverImage:"/images/drama-cover.jpg",episodes:[{id:1,number:1,title:"意外的相遇",duration:340,videoUrl:"https://example.com/video1.mp4",thumbnail:"/images/ep1-thumb.jpg",isVip:!1,watched:!0},{id:2,number:2,title:"契约的开始",duration:365,videoUrl:"https://example.com/video2.mp4",thumbnail:"/images/ep2-thumb.jpg",isVip:!1,watched:!1},{id:3,number:3,title:"心动的瞬间",duration:352,videoUrl:"https://example.com/video3.mp4",thumbnail:"/images/ep3-thumb.jpg",isVip:!0,watched:!1},{id:4,number:4,title:"误会与和解",duration:378,videoUrl:"https://example.com/video4.mp4",thumbnail:"/images/ep4-thumb.jpg",isVip:!0,watched:!1},{id:5,number:5,title:"真心的告白",duration:395,videoUrl:"https://example.com/video5.mp4",thumbnail:"/images/ep5-thumb.jpg",isVip:!0,watched:!1}]},this.episodeData=this.dramaData.episodes.find(e=>e.number===this.episodeId)||this.dramaData.episodes[0]}catch(e){console.error("Failed to load drama data:",e),this.showError("剧集加载失败")}}updatePageInfo(){document.querySelector(".drama-title").textContent=this.dramaData.title,document.querySelector(".current-episode-title").textContent=`第${this.episodeData.number}集 ${this.episodeData.title}`,document.querySelector(".episode-description").textContent="这里是剧集描述，将会从API获取实际内容。"}initPlayer(){const e=document.getElementById("player-container");if(!e)return;const t=this.buildSources(),i=this.buildSubtitles();this.player=new VideoPlayer(e,{sources:t,subtitles:i,poster:this.episodeData.thumbnail||"/images/poster.jpg",autoplay:!0,enableDanmaku:!0,enableDownload:!0,enablePictureInPicture:!0,defaultPlaybackRate:1,theme:"dark"}),this.setupPlayerEvents()}buildSources(){return[{url:this.episodeData.videoUrl,quality:"1080p",type:"video/mp4",label:"1080p",selected:!0},{url:this.episodeData.videoUrl.replace(".mp4","_720p.mp4"),quality:"720p",type:"video/mp4",label:"720p"},{url:this.episodeData.videoUrl.replace(".mp4","_480p.mp4"),quality:"480p",type:"video/mp4",label:"480p"}]}buildSubtitles(){return[{url:"/subtitles/en.vtt",lang:"en",label:"English",default:!0},{url:"/subtitles/zh.vtt",lang:"zh",label:"中文"},{url:"/subtitles/es.vtt",lang:"es",label:"Español"}]}setupPlayerEvents(){this.player&&(this.player.on("prevEpisode",()=>{this.switchEpisode(this.episodeId-1)}),this.player.on("nextEpisode",()=>{this.switchEpisode(this.episodeId+1)}),this.player.on("showSubtitleMenu",()=>{this.toggleSubtitleMenu()}),this.player.on("showQualityMenu",()=>{this.toggleQualityMenu()}),this.player.on("showSpeedMenu",()=>{this.toggleSpeedMenu()}),this.player.on("ended",()=>{this.episodeId<this.dramaData.episodes.length&&this.showNextEpisodePrompt()}),this.player.on("error",e=>{console.error("Player error:",e),this.showError("播放出错，请重试")}))}loadEpisodeList(){const e=document.getElementById("episode-list");e&&(e.innerHTML="",this.dramaData.episodes.forEach(t=>{const i=document.createElement("div");i.className="episode-item",t.number===this.episodeId&&i.classList.add("active"),t.isVip&&!this.isVIP()&&i.classList.add("locked"),i.innerHTML=`\n                <div class="episode-number">${t.number}</div>\n                <div class="episode-info">\n                    <div class="episode-title">${t.title}</div>\n                    <div class="episode-duration">${this.formatDuration(t.duration)}</div>\n                </div>\n                ${t.watched?'<div class="watched-badge">已观看</div>':""}\n                ${t.isVip?'<i class="fas fa-crown vip-icon"></i>':""}\n            `,i.addEventListener("click",()=>{t.isVip&&!this.isVIP()?this.showVIPPrompt():this.switchEpisode(t.number)}),e.appendChild(i)}))}switchEpisode(e){if(e===this.episodeId)return;if(!this.dramaData.episodes.find(t=>t.number===e))return;const t=new URL(window.location);t.searchParams.set("episode",e),window.history.pushState({},"",t),window.location.reload()}toggleSubtitleMenu(){const e=document.querySelector(".player-subtitle-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-quality-menu")?.classList.remove("show"),document.querySelector(".player-speed-menu")?.classList.remove("show"),this.buildSubtitleMenu(e),e.classList.add("show")))}buildSubtitleMenu(e){e.innerHTML="";const t=document.createElement("div");t.className="menu-item",t.textContent="关闭字幕",t.addEventListener("click",()=>{this.player&&this.player.setSubtitle(null),e.classList.remove("show")}),e.appendChild(t),[{lang:"en",label:"English"},{lang:"zh",label:"中文"},{lang:"es",label:"Español"}].forEach(t=>{const i=document.createElement("div");i.className="menu-item",i.textContent=t.label,i.addEventListener("click",()=>{this.player&&this.player.setSubtitle(t.lang),e.classList.remove("show")}),e.appendChild(i)})}toggleQualityMenu(){const e=document.querySelector(".player-quality-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-subtitle-menu")?.classList.remove("show"),document.querySelector(".player-speed-menu")?.classList.remove("show"),this.buildQualityMenu(e),e.classList.add("show")))}buildQualityMenu(e){e.innerHTML="",["1080p","720p","480p","360p"].forEach(t=>{const i=document.createElement("div");i.className="menu-item",i.textContent=t,i.addEventListener("click",()=>{this.player&&this.player.setQuality(t),e.classList.remove("show")}),e.appendChild(i)})}toggleSpeedMenu(){const e=document.querySelector(".player-speed-menu");e&&(e.classList.contains("show")?e.classList.remove("show"):(document.querySelector(".player-quality-menu")?.classList.remove("show"),document.querySelector(".player-subtitle-menu")?.classList.remove("show"),this.buildSpeedMenu(e),e.classList.add("show")))}buildSpeedMenu(e){e.innerHTML="",[.5,.75,1,1.25,1.5,2].forEach(t=>{const i=document.createElement("div");i.className="menu-item",i.textContent=`${t}x`,i.addEventListener("click",()=>{this.player&&this.player.setPlaybackRate(t),e.classList.remove("show")}),e.appendChild(i)})}isVIP(){return window.auth&&window.auth.isVIP()}showVIPPrompt(){confirm("该剧集为VIP专属，是否开通VIP会员？")&&window.router.navigate("/payment",{vip:!0})}showNextEpisodePrompt(){const e=this.dramaData.episodes[this.episodeId];if(!e)return;if(e.isVip&&!this.isVIP())return;const t=document.createElement("div");t.className="next-episode-prompt",t.innerHTML=`\n            <div class="prompt-content">\n                <p>即将播放下一集: ${e.title}</p>\n                <div class="prompt-actions">\n                    <button class="btn-secondary" id="cancelNext">取消</button>\n                    <button class="btn-primary" id="playNext">播放</button>\n                </div>\n            </div>\n        `,document.querySelector(".player-container").appendChild(t),document.getElementById("playNext")?.addEventListener("click",()=>{this.switchEpisode(this.episodeId+1)}),document.getElementById("cancelNext")?.addEventListener("click",()=>{t.remove()}),setTimeout(()=>{t.parentNode&&t.remove()},5e3)}initWatchHistory(){if(!window.auth.isLoggedIn())return;let e=0;this.player&&this.player.on("timeupdate",()=>{const t=this.player.state.currentTime;t-e>=30&&(e=t,this.saveWatchProgress(t))})}async saveWatchProgress(e){try{await fetch("/api/watch-history",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({dramaId:this.dramaId,episodeId:this.episodeId,progress:e,total:this.episodeData.duration})})}catch(e){console.error("Failed to save watch progress:",e)}}formatDuration(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`}bindEvents(){document.getElementById("backBtn")?.addEventListener("click",()=>{window.history.back()}),document.getElementById("shareBtn")?.addEventListener("click",()=>{this.handleShare()}),document.getElementById("downloadBtn")?.addEventListener("click",()=>{this.handleDownload()}),document.getElementById("likeBtn")?.addEventListener("click",()=>{this.handleLike()}),document.getElementById("favoriteBtn")?.addEventListener("click",()=>{this.handleFavorite()}),document.getElementById("sendDanmaku")?.addEventListener("click",()=>{this.sendDanmaku()}),document.getElementById("danmakuInput")?.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendDanmaku()})}handleShare(){navigator.share?navigator.share({title:`${this.dramaData.title} 第${this.episodeId}集`,url:window.location.href}).catch(console.error):navigator.clipboard.writeText(window.location.href).then(()=>this.showToast("链接已复制")).catch(console.error)}handleDownload(){window.auth.isLoggedIn()?!this.episodeData.isVip||this.isVIP()?this.showToast("下载功能开发中"):this.showVIPPrompt():window.router.navigate("/login",{redirect:"player"})}handleLike(){if(!window.auth.isLoggedIn())return void window.router.navigate("/login",{redirect:"player"});const e=document.getElementById("likeBtn");e.classList.toggle("active");const t=e.querySelector("span");if(t){let i=parseInt(t.textContent.replace("K",""));e.classList.contains("active")?(i++,t.textContent=i>1e3?(i/1e3).toFixed(1)+"K":i):(i--,t.textContent=i>1e3?(i/1e3).toFixed(1)+"K":i)}}handleFavorite(){if(!window.auth.isLoggedIn())return void window.router.navigate("/login",{redirect:"player"});const e=document.getElementById("favoriteBtn");e.classList.toggle("active");const t=e.classList.contains("active")?"已添加到收藏":"已取消收藏";this.showToast(t)}sendDanmaku(){const e=document.getElementById("danmakuInput"),t=e.value.trim();t&&this.player&&this.player.sendDanmaku&&(this.player.sendDanmaku(t,{color:"#FFFFFF",size:25,position:"scroll"}),e.value="")}showLoading(){const e=document.getElementById("pageLoading");e&&e.classList.add("show")}hideLoading(){const e=document.getElementById("pageLoading");e&&e.classList.remove("show")}showToast(e){const t=new CustomEvent("showToast",{detail:{message:e,type:"success"}});document.dispatchEvent(t)}showError(e){const t=new CustomEvent("showToast",{detail:{message:e,type:"error"}});document.dispatchEvent(t)}destroy(){console.log("Player page destroyed"),this.player&&this.player.destroy&&this.player.destroy()}}