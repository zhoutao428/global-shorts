export default class PaymentPage{constructor(e){this.params=e,this.activeTab=e.tab||"coins",this.selectedPackage=null,this.selectedPaymentMethod="card",this.promoCode=null,this.discount=0,this.init()}async init(){console.log("Payment page initialized",this.params),window.auth.isLoggedIn()?(this.showLoading(),this.initTabs(),await this.loadCoinPackages(),await this.loadVipPlans(),await this.loadTransactionHistory(),this.bindEvents(),this.hideLoading(),"coins"!==this.activeTab&&this.switchTab(this.activeTab)):window.router.navigate("/login",{redirect:"payment"})}initTabs(){document.querySelectorAll(".payment-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;this.switchTab(t)})})}switchTab(e){this.activeTab=e,document.querySelectorAll(".payment-tab").forEach(t=>{t.dataset.tab===e?t.classList.add("active"):t.classList.remove("active")}),document.querySelectorAll(".tab-content").forEach(t=>{t.id===`${e}Tab`?t.classList.add("active"):t.classList.remove("active")});const t=new URL(window.location);t.searchParams.set("tab",e),window.history.replaceState({},"",t)}async loadCoinPackages(){try{this.coinPackages=[{id:1,coins:100,price:.99,bonus:0,popular:!1,originalPrice:.99},{id:2,coins:500,price:4.99,bonus:50,popular:!1,originalPrice:4.99,discount:0},{id:3,coins:1200,price:9.99,bonus:200,popular:!0,originalPrice:11.99,discount:17},{id:4,coins:2500,price:19.99,bonus:500,popular:!1,originalPrice:24.99,discount:20},{id:5,coins:6500,price:49.99,bonus:1500,popular:!1,originalPrice:64.99,discount:23},{id:6,coins:14e3,price:99.99,bonus:4e3,popular:!1,originalPrice:139.99,discount:29}],this.renderCoinPackages()}catch(e){console.error("Failed to load coin packages:",e),this.showError("加载套餐失败")}}renderCoinPackages(){const e=document.getElementById("coinPackages");e&&(e.innerHTML="",this.coinPackages.forEach(t=>{const s=document.createElement("div");s.className="package-card",t.popular&&s.classList.add("popular"),s.innerHTML=`\n                ${t.popular?'<div class="popular-badge">最受欢迎</div>':""}\n                <div class="package-icon">\n                    <i class="fas fa-coins"></i>\n                </div>\n                <div class="package-amount">${t.coins.toLocaleString()} 金币</div>\n                ${t.bonus>0?`<div class="package-bonus">+ ${t.bonus} 额外赠送</div>`:""}\n                <div class="package-price">\n                    ${t.discount?`<span class="original-price">$${t.originalPrice.toFixed(2)}</span>`:""}\n                    <span class="current-price">$${t.price.toFixed(2)}</span>\n                </div>\n                ${t.discount?`<div class="package-discount">节省 ${t.discount}%</div>`:""}\n                <button class="buy-btn" data-package='${JSON.stringify(t)}'>\n                    立即购买\n                </button>\n            `,e.appendChild(s)}))}async loadVipPlans(){try{this.vipPlans=[{id:1,name:"月度VIP",duration:30,price:9.99,originalPrice:9.99,discount:0,popular:!1,features:["无广告观看","独家内容访问","高清画质","提前观看新剧集"]},{id:2,name:"季度VIP",duration:90,price:24.99,originalPrice:29.97,discount:17,popular:!0,features:["所有月度VIP权益","额外20%金币奖励","专属客服","生日礼物"]},{id:3,name:"年度VIP",duration:365,price:79.99,originalPrice:119.88,discount:33,popular:!1,features:["所有季度VIP权益","专属VIP徽章","线下活动优先权","年度会员礼盒"]}],this.renderVipPlans()}catch(e){console.error("Failed to load VIP plans:",e),this.showError("加载VIP套餐失败")}}renderVipPlans(){const e=document.getElementById("vipPackages");e&&(e.innerHTML="",this.vipPlans.forEach(t=>{const s=document.createElement("div");s.className="vip-card",t.popular&&s.classList.add("popular"),s.innerHTML=`\n                ${t.popular?'<div class="popular-badge">最受欢迎</div>':""}\n                <div class="vip-icon">\n                    <i class="fas fa-crown"></i>\n                </div>\n                <h3 class="vip-name">${t.name}</h3>\n                <div class="vip-duration">${t.duration}天</div>\n                <div class="vip-price">\n                    ${t.discount?`<span class="original-price">$${t.originalPrice.toFixed(2)}</span>`:""}\n                    <span class="current-price">$${t.price.toFixed(2)}</span>\n                </div>\n                ${t.discount?`<div class="vip-discount">节省 ${t.discount}%</div>`:""}\n                <ul class="vip-features">\n                    ${t.features.map(e=>`<li><i class="fas fa-check"></i> ${e}</li>`).join("")}\n                </ul>\n                <button class="buy-vip-btn" data-plan='${JSON.stringify(t)}'>\n                    立即开通\n                </button>\n            `,e.appendChild(s)}))}async loadTransactionHistory(){try{this.transactions=[{id:1,type:"purchase",item:"1200金币套餐",amount:9.99,status:"success",date:"2024-03-15 14:30",paymentMethod:"信用卡"},{id:2,type:"subscription",item:"月度VIP",amount:9.99,status:"success",date:"2024-03-01 10:15",paymentMethod:"PayPal"},{id:3,type:"purchase",item:"500金币套餐",amount:4.99,status:"pending",date:"2024-02-28 16:45",paymentMethod:"Google Pay"},{id:4,type:"purchase",item:"2500金币套餐",amount:19.99,status:"success",date:"2024-02-20 11:20",paymentMethod:"信用卡"},{id:5,type:"subscription",item:"季度VIP",amount:24.99,status:"success",date:"2024-02-01 09:30",paymentMethod:"PayPal"}],this.renderTransactionHistory()}catch(e){console.error("Failed to load transactions:",e)}}renderTransactionHistory(){const e=document.getElementById("transactionHistory");e&&(0!==this.transactions.length?(e.innerHTML="",this.transactions.forEach(t=>{const s=document.createElement("div");s.className="history-item";const a="success"===t.status?"success":"pending"===t.status?"pending":"failed";s.innerHTML=`\n                <div class="history-info">\n                    <div class="history-icon ${a}">\n                        <i class="fas ${this.getStatusIcon(t.status)}"></i>\n                    </div>\n                    <div class="history-details">\n                        <h4>${t.item}</h4>\n                        <p>${t.date} · ${t.paymentMethod}</p>\n                    </div>\n                </div>\n                <div class="history-amount ${a}">\n                    $${t.amount.toFixed(2)}\n                </div>\n            `,e.appendChild(s)})):e.innerHTML='\n                <div class="empty-state">\n                    <i class="fas fa-receipt"></i>\n                    <h4>暂无交易记录</h4>\n                    <p>完成首次购买后记录将显示在这里</p>\n                </div>\n            ')}getStatusIcon(e){return{success:"fa-check-circle",pending:"fa-clock",failed:"fa-exclamation-circle",refunded:"fa-undo"}[e]||"fa-circle"}bindEvents(){document.querySelectorAll(".method-card").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".method-card").forEach(e=>e.classList.remove("active")),e.classList.add("active"),this.selectedPaymentMethod=e.dataset.method})}),document.addEventListener("click",e=>{const t=e.target.closest(".buy-btn");if(t){const e=JSON.parse(t.dataset.package);this.selectCoinPackage(e)}const s=e.target.closest(".buy-vip-btn");if(s){const e=JSON.parse(s.dataset.plan);this.selectVipPlan(e)}}),document.getElementById("paymentForm")?.addEventListener("submit",e=>{e.preventDefault(),this.processPayment()}),document.getElementById("applyPromoBtn")?.addEventListener("click",()=>{this.applyPromoCode()}),document.getElementById("promoCode")?.addEventListener("keypress",e=>{"Enter"===e.key&&this.applyPromoCode()}),document.getElementById("viewAllTransactions")?.addEventListener("click",()=>{this.switchTab("history")}),document.getElementById("backBtn")?.addEventListener("click",()=>{window.history.back()})}selectCoinPackage(e){this.selectedPackage={type:"coins",...e};const t=this.applyDiscount(e.price);this.updatePayButton(`支付 $${t.toFixed(2)}`),document.getElementById("paymentFormSection").scrollIntoView({behavior:"smooth"}),document.querySelectorAll(".package-card").forEach(e=>{e.style.borderColor=""}),event.currentTarget.closest(".package-card").style.borderColor="var(--primary)"}selectVipPlan(e){this.selectedPackage={type:"vip",...e};const t=this.applyDiscount(e.price);this.updatePayButton(`支付 $${t.toFixed(2)}`),document.getElementById("paymentFormSection").scrollIntoView({behavior:"smooth"}),document.querySelectorAll(".vip-card").forEach(e=>{e.style.borderColor=""}),event.currentTarget.closest(".vip-card").style.borderColor="var(--primary)"}applyDiscount(e){return this.discount>0?e*(1-this.discount/100):e}updatePayButton(e){const t=document.getElementById("payNowBtn");t&&(t.innerHTML=`<i class="fas fa-lock"></i> ${e}`,t.disabled=!1)}async applyPromoCode(){const e=document.getElementById("promoCode"),t=e.value.trim().toUpperCase();if(!t)return void this.showError("请输入优惠码");const s={WELCOME10:10,VIP20:20,SAVE30:30,COIN50:50};if(s[t]){if(this.discount=s[t],e.style.borderColor="var(--success)",this.showToast(`优惠码应用成功！获得${this.discount}%折扣`),this.selectedPackage){const e=this.applyDiscount(this.selectedPackage.price);this.updatePayButton(`支付 $${e.toFixed(2)}`)}}else e.style.borderColor="var(--error)",this.showError("无效的优惠码")}async processPayment(){if(!this.selectedPackage)return void this.showError("请先选择套餐");const e=document.getElementById("cardNumber")?.value.replace(/\s/g,""),t=document.getElementById("cardName")?.value,s=document.getElementById("expiry")?.value,a=document.getElementById("cvv")?.value;if(document.getElementById("email"),!(e&&t&&s&&a))return void this.showError("请填写完整的支付信息");const i=document.getElementById("payNowBtn"),n=i.innerHTML;i.innerHTML='<i class="fas fa-spinner fa-spin"></i> 处理中...',i.disabled=!0;try{if(await new Promise(e=>setTimeout(e,2e3)),!(Math.random()>.1))throw new Error("Payment failed");{const e=this.applyDiscount(this.selectedPackage.price),t={id:Date.now(),type:"coins"===this.selectedPackage.type?"purchase":"subscription",item:"coins"===this.selectedPackage.type?`${this.selectedPackage.coins}金币套餐`:this.selectedPackage.name,amount:e,status:"success",date:(new Date).toLocaleString(),paymentMethod:"card"===this.selectedPaymentMethod?"信用卡":this.selectedPaymentMethod};if(this.transactions.unshift(t),this.renderTransactionHistory(),"coins"===this.selectedPackage.type){const e=this.selectedPackage.coins+(this.selectedPackage.bonus||0);await this.updateUserCoins(e)}else await this.updateVipStatus(this.selectedPackage);this.showToast("支付成功！"),this.resetPaymentForm(),setTimeout(()=>{"vip"===this.selectedPackage.type&&window.router.navigate("/profile?tab=vip")},3e3)}}catch(e){console.error("Payment failed:",e),this.showError("支付失败，请重试"),i.innerHTML=n,i.disabled=!1}}async updateUserCoins(e){console.log(`Adding ${e} coins to user`);const t=document.querySelector(".coin-balance span");if(t){const s=parseInt(t.textContent.replace(/,/g,""));t.textContent=(s+e).toLocaleString()}}async updateVipStatus(e){console.log(`Upgrading to VIP ${e.name}`)}resetPaymentForm(){document.getElementById("paymentForm")?.reset(),document.getElementById("payNowBtn").innerHTML='<i class="fas fa-lock"></i> 立即支付',document.getElementById("payNowBtn").disabled=!0,this.selectedPackage=null,this.discount=0,document.getElementById("promoCode").value="",document.querySelectorAll(".package-card, .vip-card").forEach(e=>{e.style.borderColor=""})}formatCardNumber(e){let t=e.value.replace(/\D/g,"");t=t.replace(/(.{4})/g,"$1 ").trim(),e.value=t.substring(0,19)}formatExpiry(e){let t=e.value.replace(/\D/g,"");t.length>=2&&(t=t.substring(0,2)+"/"+t.substring(2,4)),e.value=t}showLoading(){const e=document.getElementById("pageLoading");e&&e.classList.add("show")}hideLoading(){const e=document.getElementById("pageLoading");e&&e.classList.remove("show")}showToast(e){const t=new CustomEvent("showToast",{detail:{message:e,type:"success"}});document.dispatchEvent(t)}showError(e){const t=new CustomEvent("showToast",{detail:{message:e,type:"error"}});document.dispatchEvent(t)}destroy(){console.log("Payment page destroyed")}}