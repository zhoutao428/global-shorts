export default class ProfilePage{constructor(t){this.params=t,this.userData=null,this.activeTab="profile",this.init()}async init(){console.log("Profile page initialized",this.params),window.auth.isLoggedIn()?(this.showLoading(),await this.loadUserData(),this.initTabs(),this.loadProfileData(),this.loadHistoryData(),this.loadFavoritesData(),this.bindEvents(),this.hideLoading()):window.router.navigate("/login",{redirect:"profile"})}async loadUserData(){try{this.userData={id:"user_123",username:"john_smith",email:"john@example.com",fullName:"John Smith",avatar:"/images/default-avatar.jpg",coins:1250,isVip:!0,vipExpiresAt:"2024-12-31",watchHours:142,dramasWatched:38,episodesWatched:245,createdAt:"2024-01-15",country:"US",language:"en"},this.updateUserInfo()}catch(t){console.error("Failed to load user data:",t),this.showError("加载用户数据失败")}}updateUserInfo(){const t=document.querySelector(".profile-avatar");if(t){const e=this.userData.username.charAt(0).toUpperCase();t.textContent=e}if(document.querySelector(".profile-name").innerHTML=`\n            ${this.userData.fullName||this.userData.username}\n            ${this.userData.isVip?'<span class="vip-badge"><i class="fas fa-crown"></i> VIP</span>':""}\n        `,document.querySelector(".profile-email").innerHTML=`\n            <i class="fas fa-envelope"></i> ${this.userData.email}\n        `,document.getElementById("watchHours").textContent=this.userData.watchHours,document.getElementById("dramaCount").textContent=this.userData.dramasWatched,document.getElementById("episodeCount").textContent=this.userData.episodesWatched,this.userData.isVip){const t=document.querySelector(".vip-status-container");if(t){const e=new Date(this.userData.vipExpiresAt),i=Math.ceil((e-new Date)/864e5);t.querySelector(".vip-details p").textContent=`有效期至 ${this.userData.vipExpiresAt} · 剩余${i}天`}}else this.showNonVipStatus();document.querySelector(".coin-amount span").textContent=this.userData.coins.toLocaleString()}showNonVipStatus(){const t=document.querySelector(".vip-status-container");t&&(t.innerHTML='\n                <div class="vip-info">\n                    <div class="vip-icon">\n                        <i class="fas fa-crown" style="opacity: 0.3;"></i>\n                    </div>\n                    <div class="vip-details">\n                        <h3>尚未开通VIP</h3>\n                        <p>开通VIP享受无广告观看、独家内容等特权</p>\n                    </div>\n                </div>\n                <button class="btn btn-primary" id="upgradeVipBtn">\n                    <i class="fas fa-gem"></i>\n                    立即开通\n                </button>\n            ',document.getElementById("upgradeVipBtn")?.addEventListener("click",()=>{window.router.navigate("/payment",{tab:"vip"})}))}initTabs(){const t=document.querySelectorAll(".profile-tab");t.forEach(e=>{e.addEventListener("click",()=>{const i=e.dataset.tab;t.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.switchTab(i)})})}switchTab(t){this.activeTab=t,document.querySelectorAll(".tab-content").forEach(t=>{t.classList.remove("active")}),document.getElementById(`${t}Tab`).classList.add("active")}loadProfileData(){document.getElementById("displayName").value=this.userData.fullName||"",document.getElementById("email").value=this.userData.email,document.getElementById("country").value=this.userData.country||"",document.getElementById("language").value=this.userData.language||"en"}async loadHistoryData(){const t=document.getElementById("historyList");if(t)try{const e=[{id:1,dramaTitle:"总裁的秘密婚姻",episode:"第5集 契约的开始",time:"2小时前",progress:65,thumbnail:"/images/history1.jpg"},{id:2,dramaTitle:"爱情在巴黎",episode:"第12集 塞纳河畔",time:"昨天",progress:100,thumbnail:"/images/history2.jpg"},{id:3,dramaTitle:"我的狼人上司",episode:"第3集 满月之夜",time:"2天前",progress:45,thumbnail:"/images/history3.jpg"},{id:4,dramaTitle:"亿万富翁的错嫁妻",episode:"第8集 真相大白",time:"3天前",progress:80,thumbnail:"/images/history4.jpg"},{id:5,dramaTitle:"办公室恋爱101",episode:"第1集 初次见面",time:"1周前",progress:100,thumbnail:"/images/history5.jpg"}];t.innerHTML="",e.forEach(e=>{const i=this.createHistoryItem(e);t.appendChild(i)})}catch(e){console.error("Failed to load history:",e),t.innerHTML='<div class="empty-state">加载失败</div>'}}createHistoryItem(t){const e=document.createElement("div");return e.className="history-item",e.innerHTML=`\n            <div class="history-thumb">\n                <img src="${t.thumbnail}" alt="${t.dramaTitle}">\n            </div>\n            <div class="history-info">\n                <div class="history-title">${t.dramaTitle}</div>\n                <div class="history-meta">\n                    <span>${t.episode}</span>\n                    <span>${t.time}</span>\n                </div>\n                <div class="history-progress">\n                    <div class="history-progress-bar" style="width: ${t.progress}%"></div>\n                </div>\n            </div>\n        `,e.addEventListener("click",()=>{window.router.navigate(`/player/${t.id}`)}),e}async loadFavoritesData(){const t=document.getElementById("favoritesGrid");if(t)try{const e=[{id:1,title:"总裁的秘密婚姻",episodes:12,isVip:!0,thumbnail:"/images/fav1.jpg"},{id:2,title:"前妻的复仇",episodes:30,isVip:!0,thumbnail:"/images/fav2.jpg"},{id:3,title:"爱情在巴黎",episodes:24,isVip:!1,thumbnail:"/images/fav3.jpg"},{id:4,title:"血红玫瑰之谜",episodes:16,isVip:!1,thumbnail:"/images/fav4.jpg"},{id:5,title:"隔壁的吸血鬼",episodes:15,isVip:!1,thumbnail:"/images/fav5.jpg"},{id:6,title:"我的狼人上司",episodes:18,isVip:!1,thumbnail:"/images/fav6.jpg"}];t.innerHTML="",e.forEach(e=>{const i=this.createFavoriteItem(e);t.appendChild(i)})}catch(e){console.error("Failed to load favorites:",e),t.innerHTML='<div class="empty-state">加载失败</div>'}}createFavoriteItem(t){const e=document.createElement("div");return e.className="favorite-item",e.innerHTML=`\n            <div class="favorite-thumb">\n                <img src="${t.thumbnail}" alt="${t.title}">\n                ${t.isVip?'<div class="vip-badge">VIP</div>':""}\n            </div>\n            <div class="favorite-info">\n                <div class="favorite-title">${t.title}</div>\n                <div class="favorite-meta">${t.episodes}集</div>\n            </div>\n        `,e.addEventListener("click",()=>{window.router.navigate(`/player/${t.id}`)}),e}async loadTransactions(){const t=document.getElementById("transactionsList");if(t)try{const e=[{id:1,type:"earned",title:"每日签到",description:"第7天连续签到",amount:50,date:"今天"},{id:2,type:"spent",title:"解锁剧集",description:"总裁的秘密婚姻 - 第6集",amount:-30,date:"今天"},{id:3,type:"earned",title:"邀请奖励",description:"好友 Sarah 注册",amount:100,date:"昨天"},{id:4,type:"earned",title:"观看广告",description:"30秒广告奖励",amount:10,date:"2天前"},{id:5,type:"spent",title:"解锁剧集",description:"前妻的复仇 - 全集",amount:-200,date:"3天前"}];t.innerHTML="",e.forEach(e=>{const i=this.createTransactionItem(e);t.appendChild(i)})}catch(t){console.error("Failed to load transactions:",t)}}createTransactionItem(t){const e=document.createElement("div");return e.className=`transaction-item transaction-${t.type}`,e.innerHTML=`\n            <div class="transaction-info">\n                <div class="transaction-icon">\n                    <i class="fas fa-${"earned"===t.type?"plus":"minus"}"></i>\n                </div>\n                <div class="transaction-details">\n                    <h4>${t.title}</h4>\n                    <p>${t.description} · ${t.date}</p>\n                </div>\n            </div>\n            <div class="transaction-amount">\n                ${"earned"===t.type?"+":""}${t.amount}\n            </div>\n        `,e}bindEvents(){document.getElementById("editProfileBtn")?.addEventListener("click",()=>{this.showEditProfileModal()}),document.getElementById("settingsBtn")?.addEventListener("click",()=>{this.switchTab("settings")}),document.getElementById("manageVipBtn")?.addEventListener("click",()=>{window.router.navigate("/payment",{tab:"vip"})}),document.getElementById("viewAllHistory")?.addEventListener("click",()=>{this.switchTab("history")}),document.getElementById("viewAllFavorites")?.addEventListener("click",()=>{this.switchTab("favorites")}),document.getElementById("viewAllTransactions")?.addEventListener("click",()=>{window.router.navigate("/payment",{tab:"history"})}),document.getElementById("earnCoinsBtn")?.addEventListener("click",()=>{this.showEarnCoinsModal()}),document.getElementById("buyCoinsBtn")?.addEventListener("click",()=>{window.router.navigate("/payment")}),document.getElementById("withdrawCoinsBtn")?.addEventListener("click",()=>{this.showWithdrawModal()}),document.querySelectorAll(".setting-item").forEach(t=>{t.addEventListener("click",e=>{const i=t.id;this.handleSettingClick(i,e)})}),document.getElementById("saveProfileBtn")?.addEventListener("click",()=>{this.saveProfile()}),document.getElementById("cancelEditBtn")?.addEventListener("click",()=>{this.hideEditProfileModal()}),document.querySelectorAll(".close-modal").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.closest(".modal-overlay");e&&e.classList.remove("active")})}),document.querySelectorAll(".modal-overlay").forEach(t=>{t.addEventListener("click",e=>{e.target===t&&t.classList.remove("active")})}),document.getElementById("notificationToggle")?.addEventListener("change",t=>{this.saveNotificationSetting(t.target.checked)}),document.getElementById("languageSettings")?.addEventListener("click",()=>{this.showLanguageModal()}),document.getElementById("logoutBtn")?.addEventListener("click",()=>{this.handleLogout()})}handleSettingClick(t,e){if(!e.target.closest(".switch"))switch(t){case"notificationSettings":break;case"languageSettings":this.showLanguageModal();break;case"playbackSettings":this.showPlaybackSettings();break;case"privacySettings":this.showPrivacySettings();break;case"helpSettings":this.showHelp();break;case"logoutBtn":this.handleLogout()}}showEditProfileModal(){const t=document.getElementById("editProfileModal");t&&(document.getElementById("editDisplayName").value=this.userData.fullName||"",document.getElementById("editEmail").value=this.userData.email,t.classList.add("active"))}hideEditProfileModal(){const t=document.getElementById("editProfileModal");t&&t.classList.remove("active")}async saveProfile(){const t=document.getElementById("editDisplayName").value.trim(),e=document.getElementById("editEmail").value.trim();t&&e?(this.showLoading(),setTimeout(()=>{this.userData.fullName=t,this.userData.email=e,this.updateUserInfo(),this.hideEditProfileModal(),this.hideLoading(),this.showToast("资料已更新")},1e3)):this.showError("请填写所有字段")}showEarnCoinsModal(){const t=document.createElement("div");t.className="modal-overlay active",t.innerHTML='\n            <div class="modal">\n                <div class="modal-header">\n                    <h3 class="modal-title">赚取金币</h3>\n                    <button class="close-modal"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="modal-body">\n                    <div class="earn-options">\n                        <div class="earn-option">\n                            <i class="fas fa-calendar-check"></i>\n                            <div>\n                                <h4>每日签到</h4>\n                                <p>每天签到获得10-50金币</p>\n                                <button class="btn btn-primary btn-sm" id="dailyCheckinBtn">立即签到</button>\n                            </div>\n                        </div>\n                        <div class="earn-option">\n                            <i class="fas fa-users"></i>\n                            <div>\n                                <h4>邀请好友</h4>\n                                <p>每邀请一位好友获得100金币</p>\n                                <button class="btn btn-primary btn-sm" id="inviteBtn">邀请好友</button>\n                            </div>\n                        </div>\n                        <div class="earn-option">\n                            <i class="fas fa-ad"></i>\n                            <div>\n                                <h4>观看广告</h4>\n                                <p>观看广告获得5-20金币</p>\n                                <button class="btn btn-primary btn-sm" id="watchAdBtn">观看广告</button>\n                            </div>\n                        </div>\n                        <div class="earn-option">\n                            <i class="fas fa-share-alt"></i>\n                            <div>\n                                <h4>分享内容</h4>\n                                <p>分享剧集给好友获得30金币</p>\n                                <button class="btn btn-primary btn-sm" id="shareContentBtn">立即分享</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t),t.querySelector(".close-modal").addEventListener("click",()=>{t.remove()}),t.addEventListener("click",e=>{e.target===t&&t.remove()}),t.querySelector("#dailyCheckinBtn")?.addEventListener("click",()=>{this.handleCheckin()})}async handleCheckin(){this.showToast("签到成功 +50金币"),this.userData.coins+=50,document.querySelector(".coin-amount span").textContent=this.userData.coins.toLocaleString()}showWithdrawModal(){const t=document.createElement("div");t.className="modal-overlay active",t.innerHTML=`\n            <div class="modal">\n                <div class="modal-header">\n                    <h3 class="modal-title">提现金币</h3>\n                    <button class="close-modal"><i class="fas fa-times"></i></button>\n                </div>\n                <div class="modal-body">\n                    <div class="withdraw-info">\n                        <p>当前可用金币: <strong>${this.userData.coins}</strong></p>\n                        <p>1000金币 = $1.00 USD</p>\n                    </div>\n                    <div class="form-group">\n                        <label class="form-label">提现金额</label>\n                        <select class="form-control" id="withdrawAmount">\n                            <option value="1000">1000金币 ($1.00)</option>\n                            <option value="5000">5000金币 ($5.00)</option>\n                            <option value="10000">10000金币 ($10.00)</option>\n                            <option value="50000">50000金币 ($50.00)</option>\n                        </select>\n                    </div>\n                    <div class="form-group">\n                        <label class="form-label">提现方式</label>\n                        <select class="form-control" id="withdrawMethod">\n                            <option value="paypal">PayPal</option>\n                            <option value="alipay">支付宝</option>\n                            <option value="wechat">微信支付</option>\n                        </select>\n                    </div>\n                    <div class="form-group">\n                        <label class="form-label">账户信息</label>\n                        <input type="text" class="form-control" placeholder="输入你的账户邮箱/账号">\n                    </div>\n                    <button class="btn btn-primary" id="submitWithdrawBtn">提交提现申请</button>\n                </div>\n            </div>\n        `,document.body.appendChild(t),t.querySelector(".close-modal").addEventListener("click",()=>{t.remove()}),t.addEventListener("click",e=>{e.target===t&&t.remove()}),t.querySelector("#submitWithdrawBtn")?.addEventListener("click",()=>{this.showToast("提现申请已提交，预计1-3个工作日到账"),t.remove()})}showLanguageModal(){const t=document.getElementById("languageModal");t&&t.classList.add("active")}showPlaybackSettings(){this.showToast("播放设置功能开发中")}showPrivacySettings(){this.showToast("隐私设置功能开发中")}showHelp(){window.open("https://help.globalshorts.com","_blank")}async saveNotificationSetting(t){console.log("Notification setting saved:",t),this.showToast(t?"通知已开启":"通知已关闭")}handleLogout(){confirm("确定要退出登录吗？")&&(localStorage.removeItem("token"),localStorage.removeItem("user"),window.auth.logout(),window.router.navigate("/"),this.showToast("已退出登录"))}showLoading(){const t=document.getElementById("pageLoading");t&&t.classList.add("show")}hideLoading(){const t=document.getElementById("pageLoading");t&&t.classList.remove("show")}showToast(t){const e=new CustomEvent("showToast",{detail:{message:t,type:"success"}});document.dispatchEvent(e)}showError(t){const e=new CustomEvent("showToast",{detail:{message:t,type:"error"}});document.dispatchEvent(e)}destroy(){console.log("Profile page destroyed")}}