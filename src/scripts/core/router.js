const REPO_NAME="/global-shorts",IS_GITHUB=window.location.hostname.includes("github.io"),BASE_PATH=IS_GITHUB?REPO_NAME:"";class Router{constructor(){this.routes={"/":"home","/home":"home","/player":"player","/profile":"profile","/payment":"payment","/login":"login","/discover":"discover","/404":"notfound"},this.currentPage=null,this.params={},this.beforeEach=null,this.afterEach=null,this.init()}init(){window.addEventListener("popstate",t=>{this.handleRoute()}),this.interceptLinks(),this.handleRoute()}interceptLinks(){document.addEventListener("click",t=>{const e=t.target.closest("a");if(!e)return;const a=e.getAttribute("href");a&&(a.startsWith("http")||a.startsWith("#")||(t.preventDefault(),this.navigate(a)))})}handleRoute(){let t=window.location.pathname;const e=new URLSearchParams(window.location.search);this.params={};for(let[t,a]of e)this.params[t]=a;const a=this.matchRoute(t);a?this.loadPage(a):this.loadPage("notfound")}matchRoute(t){let e=t;if(BASE_PATH&&e.startsWith(BASE_PATH)&&(e=e.slice(BASE_PATH.length)),""===e||"/"===e||"/index.html"===e)return this.routes["/"];if(e.startsWith("/")||(e="/"+e),this.routes[e])return this.routes[e];const a=e.split("/").filter(t=>t);if(a.length>=1){const t="/"+a[0];if(this.routes[t])return a.length>1&&(this.params.id=a[1]),this.routes[t]}return null}navigate(t,e={}){let a=t;if(BASE_PATH&&!t.startsWith(BASE_PATH)){const e=t.startsWith("/")?t:"/"+t;a=BASE_PATH+e}Object.keys(e).length>0&&(a+=`?${new URLSearchParams(e).toString()}`),history.pushState({},"",a),this.handleRoute()}replace(t,e={}){let a=t;if(BASE_PATH&&!t.startsWith(BASE_PATH)){const e=t.startsWith("/")?t:"/"+t;a=BASE_PATH+e}Object.keys(e).length>0&&(a+=`?${new URLSearchParams(e).toString()}`),history.replaceState({},"",a),this.handleRoute()}async fetchPage(t){const e=`${BASE_PATH}/pages/${t}.html`,a=await fetch(e);if(!a.ok)throw new Error(`Page not found: ${e}`);return a.text()}async loadPageScript(t){try{const e=await import(`../pages/${t}.js`);e.default&&(window[`${t}Page`]=new e.default(this.params))}catch(e){console.warn(`Script load failed for: ${t}`,e)}}async loadPage(t){try{if(this.beforeEach&&!1===await this.beforeEach(t,this.params))return;this.showLoading();const e=await this.fetchPage(t);document.getElementById("app").innerHTML=e,this.updateTitle(t),await this.loadPageScript(t),this.currentPage=t,this.hideLoading(),this.afterEach&&this.afterEach(t,this.params),this.updateActiveNav()}catch(t){console.error("Failed to load page:",t),this.showError("页面加载失败"),this.hideLoading()}}updateTitle(t){document.title={home:"Global Shorts - 首页",player:"Global Shorts - 播放器",profile:"Global Shorts - 个人中心",payment:"Global Shorts - 充值中心",login:"Global Shorts - 登录",discover:"Global Shorts - 发现",notfound:"Global Shorts - 页面未找到"}[t]||"Global Shorts"}updateActiveNav(){document.querySelectorAll(".nav-item").forEach(t=>{t.classList.remove("active")});const t=document.querySelector(`.nav-item[data-page="${this.currentPage}"]`);t&&t.classList.add("active")}back(){history.back()}forward(){history.forward()}setBeforeEach(t){this.beforeEach=t}setAfterEach(t){this.afterEach=t}showLoading(){let t=document.getElementById("page-loading");t||(t=document.createElement("div"),t.id="page-loading",t.className="page-loading",t.innerHTML='<div class="loading-spinner"></div>',document.body.appendChild(t)),t.classList.add("show")}hideLoading(){const t=document.getElementById("page-loading");t&&t.classList.remove("show")}showError(t){const e=document.createElement("div");e.className="error-toast",e.textContent=t,document.body.appendChild(e),setTimeout(()=>e.remove(),3e3)}getCurrentPage(){return this.currentPage}getParams(){return{...this.params}}}const router=new Router;export default router;